<?php

/**
 * Implementation of hook_menu().
 */
function engage_menu() {
  $items['engage'] = array(
    'title' => 'Engage',
    'page callback' => 'engage_page',
    'access arguments' => array('access content'),
    'type' => MENU_SUGGESTED_ITEM,
  );

  return $items;
}

function engage_node_info(){
  return array('engage' => array(
    'title' => 'Tracked Twitter Engagement',
  ));
}

function engage_view($node, $teaser = FALSE, $page = FALSE) {
  $node->content['hello'] = array('#value' => 'hello');
  return node_prepare($node, $teaser);
}

function engage_cron() {
  engage_page();
}

function engage_pattern_count($pattern) {
  $result = db_query("select screen_name, count(twitter_id) from twitter where text $pattern group by screen_name;");
  while($b = db_fetch_array($result)) {
    $matches[$b['screen_name']] = $b['count'];
  }
  return $matches;
}

function engage_page() {
  $result = db_query("SELECT t.*, e.nid FROM {twitter_user} t LEFT OUTER JOIN {engage_users} e ON t.screen_name = e.screen_name");
  $output = '';

  $retweets = engage_pattern_count(" like 'RT %'");
  $engage = engage_pattern_count(" like '%@%'");
  $broadcast = engage_pattern_count("not like '%@%'");

  $headers = array('Name', '', '', '', 'ReTweets', 'Replies/mentions', 'Broadcasts', 'Percentage Interaction');

  while ($account = db_fetch_array($result)) {
    unset($node);
    if (!$account['nid']) {
      $node->title = $account['screen_name'];
      $node->type = 'engage';
      $node->published = 0;
      node_save($node);
      db_query("INSERT INTO {engage_users} (screen_name, nid) VALUES ('%s', %d)", $account['screen_name'], $node->nid);
      drupal_set_message(sprintf("New node made %d %d", $account['uid'], $node->nid) );
    }
    else {
      $node = node_load(array('nid' => $account['nid']));
    }
    $e = $engage[$account['screen_name']];
    $b = $broadcast[$account['screen_name']];
    $rt = $retweets[$account['screen_name']];
    $total = $e+$b;
    
    if ($total) 
    $percent_engage = ($e / $total) * 100;
    else
    $percent_engage = 0;
      
    $rows[] = array($account['screen_name'],
      l('user', 'user/'. $account['uid']),
      l('twitter', 'http://www.twitter.com/' . $account['screen_name']),
      l('node', 'node/'. $node->nid),
      $rt, $e, $b, sprintf('%.2f%%', $percent_engage),
    );
  }
  $output .= theme('table', $headers, $rows);

  return $output;
}